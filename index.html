<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>åšå‡±è¨˜å¸³ v0.1ï¼ˆé›¢ç·šæ¸¬è©¦ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#11151b; --muted:#9aa4b2; --text:#e6edf3;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --line:#1f2937;
      --chip:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,"PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,13,16,.92);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 26px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:800;font-size:20px;letter-spacing:.5px}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(17,21,27,.6)}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button, input, select, textarea{font:inherit}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,rgba(34,197,94,.20),rgba(34,197,94,.06));border-color:rgba(34,197,94,.35)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(17,21,27,.9);color:var(--text);cursor:pointer}
    .btn.primary{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.30)}
    .btn.ghost{background:transparent}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:720px){.g2,.g3{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h3{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:700}
    .big{font-size:28px;font-weight:900;letter-spacing:.5px}
    .big.green{color:var(--accent)} .big.red{color:var(--danger)}
    .big.warn{color:var(--warn)}
    .sub{color:var(--muted);font-size:12px}
    .form{display:grid;gap:10px}
    label{display:grid;gap:6px;color:var(--muted);font-size:12px}
    input, select, textarea{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0c1117;color:var(--text)
    }
    textarea{min-height:76px;resize:vertical}
    .seg{display:flex;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .seg button{flex:1;padding:10px;border:0;background:transparent;color:var(--muted)}
    .seg button.active{background:rgba(239,68,68,.18);color:var(--text)}
    .seg button.active.in{background:rgba(34,197,94,.18)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(15,23,42,.55);cursor:pointer;color:var(--text)}
    .chip.active{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.10)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:13px}
    th{color:var(--muted);font-weight:700;text-align:left}
    .amt.in{color:var(--accent);font-weight:800}
    .amt.out{color:var(--danger);font-weight:800}
    .k{color:var(--muted)}
    .right{margin-left:auto}
    .empty{color:var(--muted);text-align:center;padding:18px;border:1px dashed var(--line);border-radius:14px}
    .footerNote{color:var(--muted);font-size:12px;line-height:1.6}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0c1117;border:1px solid var(--line);padding:10px 12px;border-radius:14px;display:none;max-width:92vw}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="title">åšå‡±è¨˜å¸³ v0.1</div>
      <div class="pill">é›¢ç·šæ¸¬è©¦ç‰ˆï¼ˆè³‡æ–™å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼‰</div>
      <div class="right row">
        <button class="btn ghost" id="btnReset">æ¸…ç©ºè³‡æ–™</button>
        <button class="btn" id="btnExport">åŒ¯å‡º CSV</button>
      </div>
    </div>
    <nav id="tabs"></nav>
  </div>
</header>

<main class="wrap">
  <section id="view"></section>
  <div style="height:14px"></div>
  <div class="footerNote">
    âœ… é€™æ˜¯ã€Œå…ˆè®“ä½ é‚Šç”¨é‚Šæ¸¬ã€çš„ç‰ˆæœ¬ï¼šä¸éœ€è¦ç™»å…¥ã€ä¸éœ€è¦é›²ç«¯ã€‚<br/>
    ä¸‹ä¸€æ­¥æˆ‘å€‘æœƒæŠŠä½ è¦ºå¾—é †æ‰‹çš„æµç¨‹ç•™ä¸‹ä¾†ï¼Œå†å‡ç´šåˆ° v1ï¼ˆé›²ç«¯åŒæ­¥/å¤šè£ç½®/æ”¶æ“šç…§ç‰‡ï¼‰ã€‚<br/>
    å°æé†’ï¼šå¦‚æœä½ æ¸…é™¤ç€è¦½å™¨è³‡æ–™ï¼Œæœ¬æ©Ÿå¸³ä¹Ÿæœƒè¢«æ¸…æ‰ã€‚
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/** ---------- storage ---------- **/
const KEY="bokai_bookkeeper_v01";
function loadState(){
  try{
    const raw=localStorage.getItem(KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return {
    settings:{currency:"TWD"},
    lastUsed:{type:"out", accountId:"cash", categoryPath:"é¤é£²/é¤é£²"},
    accounts:[
      {id:"cash", name:"ç¾é‡‘", kind:"ç¾é‡‘", balance:0},
      {id:"bank", name:"éŠ€è¡Œ", kind:"éŠ€è¡Œ", balance:0},
      {id:"card", name:"ä¿¡ç”¨å¡", kind:"ä¿¡ç”¨å¡", balance:0},
      {id:"company", name:"å…¬å¸", kind:"å…¬å¸", balance:0},
    ],
    categories:[
      {parent:"é¤é£²", icon:"ğŸ½ï¸", locked:true, children:["é¤é£²","æ—©é¤","ä¸‹åˆèŒ¶","å®µå¤œ"]},
      {parent:"äº¤é€š", icon:"ğŸšŒ", locked:true, children:["æ·é‹","å…¬è»Š","è¨ˆç¨‹è»Š","åœè»Š"]},
      {parent:"å±…ä½", icon:"ğŸ ", locked:true, children:["æˆ¿ç§Ÿ","æ°´é›»","ç®¡ç†è²»"]},
      {parent:"é€šè¨Š", icon:"ğŸ“±", locked:true, children:["é›»ä¿¡","ç¶²è·¯","è¨‚é–±"]},
      {parent:"æ•™è‚²", icon:"ğŸ“", locked:true, children:["èª²ç¨‹","æ›¸ç±"]},
    ],
    tx:[]
  }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
let state = loadState();

/** ---------- helpers ---------- **/
const fmt = (n)=> (Number(n)||0).toLocaleString("zh-Hant-TW",{maximumFractionDigits:2, minimumFractionDigits:0});
const todayISO = ()=> new Date().toISOString().slice(0,10);
function toast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=> el.style.display="none", 1600);
}
function getMonthKey(d){ return (d||todayISO()).slice(0,7); }
function sumForMonth(monthKey){
  let inc=0, out=0;
  state.tx.filter(t=>t.date.startsWith(monthKey)).forEach(t=>{
    if(t.type==="in") inc += Number(t.amount)||0;
    else out += Number(t.amount)||0;
  });
  return {inc,out, net: inc-out};
}
function accountById(id){ return state.accounts.find(a=>a.id===id); }

/** ---------- tabs ---------- **/
const TABLIST=[
  {id:"overview", label:"ç¸½è¦½"},
  {id:"quick", label:"å¿«é€Ÿè¨˜å¸³"},
  {id:"tx", label:"å¸³ç›®åˆ—è¡¨"},
  {id:"accounts", label:"å¸³æˆ¶ç®¡ç†"},
  {id:"categories", label:"åˆ†é¡ç®¡ç†"},
];
let activeTab = "overview";

function renderTabs(){
  const nav=document.getElementById("tabs");
  nav.innerHTML="";
  TABLIST.forEach(t=>{
    const b=document.createElement("button");
    b.className="tab"+(t.id===activeTab?" active":"");
    b.textContent=t.label;
    b.onclick=()=>{activeTab=t.id; render();};
    nav.appendChild(b);
  });
}

/** ---------- views ---------- **/
function viewOverview(){
  const month=getMonthKey();
  const {inc,out,net}=sumForMonth(month);

  return `
  <div class="row" style="margin:6px 0 12px">
    <div class="pill">æœ¬æœˆï¼š${month.replace("-","å¹´")}æœˆ</div>
    <button class="btn primary right" onclick="goQuick()">ï¼‹ è¨˜ä¸€ç­†</button>
  </div>

  <div class="grid g3">
    <div class="card">
      <h3>æœ¬æœˆæ”¶å…¥</h3>
      <div class="big green">$${fmt(inc)}</div>
    </div>
    <div class="card">
      <h3>æœ¬æœˆæ”¯å‡º</h3>
      <div class="big red">$${fmt(out)}</div>
    </div>
    <div class="card">
      <h3>æœ¬æœˆçµé¤˜</h3>
      <div class="big ${net>=0?"green":"red"}">${net>=0?"+":""}$${fmt(net)}</div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <h3>æœ€è¿‘ 10 ç­†</h3>
    ${renderTxTable(state.tx.slice().sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)).slice(0,10))}
  </div>
  `;
}

function viewQuick(){
  const last=state.lastUsed || {type:"out"};
  const defaultType = last.type || "out";
  const defaultAcc = last.accountId || state.accounts[0]?.id || "cash";
  const defaultPath = last.categoryPath || "é¤é£²/é¤é£²";

  const [defaultParent, defaultChild] = defaultPath.split("/");

  const parentOptions = state.categories.map(c=>`<option value="${c.parent}" ${c.parent===defaultParent?"selected":""}>${c.parent}</option>`).join("");

  const childOptions = (state.categories.find(c=>c.parent===defaultParent)?.children||[]).map(ch=>`<option value="${ch}" ${ch===defaultChild?"selected":""}>${ch}</option>`).join("");

  const accOptions = state.accounts.map(a=>`<option value="${a.id}" ${a.id===defaultAcc?"selected":""}>${a.name}ï¼ˆ${a.kind}ï¼‰</option>`).join("");

  return `
  <div class="card">
    <h3>å¿«é€Ÿè¨˜å¸³</h3>

    <div class="seg" role="tablist" aria-label="æ”¶æ”¯åˆ‡æ›">
      <button id="segOut" class="${defaultType==="out"?"active":""}" onclick="setType('out')">æ”¯å‡º</button>
      <button id="segIn" class="${defaultType==="in"?"active in":""}" onclick="setType('in')">æ”¶å…¥</button>
    </div>

    <div style="height:10px"></div>

    <div class="form">
      <label>é‡‘é¡
        <input id="amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š120" />
      </label>

      <label>å¸³æˆ¶
        <select id="account">${accOptions}</select>
      </label>

      <div class="grid g2">
        <label>åˆ†é¡ï¼ˆçˆ¶ï¼‰
          <select id="parentCat" onchange="onParentChange()">${parentOptions}</select>
        </label>
        <label>åˆ†é¡ï¼ˆå­ï¼‰
          <select id="childCat">${childOptions}</select>
        </label>
      </div>

      <div class="grid g2">
        <label>æ—¥æœŸ
          <input id="date" type="date" value="${todayISO()}" />
        </label>
        <label>æ™‚é–“
          <input id="time" type="time" value="${new Date().toTimeString().slice(0,5)}" />
        </label>
      </div>

      <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰
        <textarea id="note" placeholder="ä¾‹å¦‚ï¼šåˆé¤ / å®¢æˆ¶è«‹å®¢ / ææ–™è²»â€¦"></textarea>
      </label>

      <div class="row">
        <button class="btn primary" onclick="saveTx()">å„²å­˜</button>
        <button class="btn" onclick="saveTx(true)">å„²å­˜ä¸¦å†è¨˜ä¸€ç­†</button>
        <span class="right sub">æœƒè‡ªå‹•è¨˜ä½ä½ ä¸Šæ¬¡çš„åˆ†é¡/å¸³æˆ¶</span>
      </div>
    </div>
  </div>
  `;
}

function renderTxTable(items){
  if(!items.length) return `<div class="empty">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚ä½ å¯ä»¥å…ˆå»ã€Œå¿«é€Ÿè¨˜å¸³ã€æ–°å¢ä¸€ç­†è©¦è©¦ã€‚</div>`;
  const rows = items.map(t=>{
    const acc = accountById(t.accountId)?.name || t.accountId;
    const sign = t.type==="in"?"+":"-";
    const cls = t.type==="in"?"in":"out";
    return `<tr>
      <td>${t.date}<div class="sub">${t.time||""}</div></td>
      <td>${acc}</td>
      <td>${t.categoryPath}</td>
      <td class="amt ${cls}">${sign}$${fmt(t.amount)}</td>
      <td>${t.note?escapeHtml(t.note):"<span class='k'>â€”</span>"}</td>
      <td style="text-align:right">
        <button class="btn ghost" onclick="delTx('${t.id}')">åˆª</button>
      </td>
    </tr>`;
  }).join("");
  return `<div style="overflow:auto">
    <table>
      <thead><tr>
        <th>æ—¥æœŸ</th><th>å¸³æˆ¶</th><th>åˆ†é¡</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th></th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function viewTx(){
  const month=getMonthKey();
  const opts = [...new Set(state.tx.map(t=>getMonthKey(t.date)))].sort().reverse();
  const monthOptions = [`<option value="${month}">${month}</option>`].concat(
    opts.filter(m=>m!==month).map(m=>`<option value="${m}">${m}</option>`)
  ).join("");

  return `
  <div class="card">
    <div class="row">
      <h3 style="margin:0">å¸³ç›®åˆ—è¡¨</h3>
      <div class="right row">
        <label class="sub">æœˆä»½
          <select id="txMonth" onchange="render()">${monthOptions}</select>
        </label>
        <button class="btn danger" onclick="deleteMonth()">æœˆä»½åˆªé™¤</button>
        <button class="btn danger" onclick="deleteAll()">å…¨éƒ¨åˆªé™¤</button>
      </div>
    </div>
    <div style="height:10px"></div>
    ${renderTxTable(state.tx.filter(t=>t.date.startsWith(document.getElementById("txMonth")?.value || month)).sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time)))}
  </div>
  `;
}

function viewAccounts(){
  // recompute balances quickly from tx
  const balances = {};
  state.accounts.forEach(a=>balances[a.id]=0);
  state.tx.forEach(t=>{
    const v=Number(t.amount)||0;
    balances[t.accountId]=(balances[t.accountId]||0) + (t.type==="in"? v : -v);
  });

  const totalAssets = Object.entries(balances).filter(([id])=> {
    const k=accountById(id)?.kind;
    return k!=="ä¿¡ç”¨å¡";
  }).reduce((s,[,v])=>s+v,0);
  const totalDebt = Object.entries(balances).filter(([id])=>accountById(id)?.kind==="ä¿¡ç”¨å¡").reduce((s,[,v])=>s+Math.max(0,-v),0);
  const net = totalAssets - totalDebt;

  const cards = state.accounts.map(a=>{
    const b = balances[a.id]||0;
    const isCard = a.kind==="ä¿¡ç”¨å¡";
    const shown = isCard ? (-b) : b;
    return `<div class="card">
      <div class="row">
        <div style="font-weight:900">${a.name}</div>
        <div class="pill">${a.kind}</div>
        <button class="btn ghost right" onclick="renameAccount('${a.id}')">ç·¨è¼¯</button>
      </div>
      <div style="height:6px"></div>
      <div class="big ${shown>=0?"green":"red"}">$${fmt(shown)}</div>
      <div class="sub">${isCard?"ï¼ˆä¿¡ç”¨å¡é¡¯ç¤ºæ¬ æ¬¾ï¼‰":"ï¼ˆæ”¶æ”¯ç´¯ç©ï¼‰"}</div>
    </div>`;
  }).join("");

  return `
  <div class="grid g3">
    <div class="card"><h3>ç¸½è³‡ç”¢</h3><div class="big green">$${fmt(totalAssets)}</div></div>
    <div class="card"><h3>ç¸½è² å‚µ</h3><div class="big red">$${fmt(totalDebt)}</div></div>
    <div class="card"><h3>æ·¨è³‡ç”¢</h3><div class="big ${net>=0?"green":"red"}">$${fmt(net)}</div></div>
  </div>
  <div style="height:12px"></div>
  <div class="row">
    <button class="btn primary" onclick="addAccount()">ï¼‹ æ–°å¢å¸³æˆ¶</button>
    <div class="sub">v0.1 å…ˆåšæœ€å°å¯ç”¨ï¼šå¸³æˆ¶åç¨±å¯æ”¹ã€å¯æ–°å¢ï¼›é¡å‹åˆ†ç‚º ç¾é‡‘/éŠ€è¡Œ/ä¿¡ç”¨å¡/å…¬å¸</div>
  </div>
  <div style="height:10px"></div>
  <div class="grid g2">${cards}</div>
  `;
}

function viewCategories(){
  const items = state.categories.map((c,idx)=>{
    const children = c.children.map(ch=>`<span class="pill" style="border-style:dashed">${ch}</span>`).join(" ");
    return `<div class="card">
      <div class="row">
        <div style="font-weight:900">${c.icon} ${c.parent}</div>
        ${c.locked?`<div class="pill">é è¨­åˆ†é¡</div>`:`<div class="pill">è‡ªè¨‚</div>`}
        <button class="btn ghost right" onclick="addChild(${idx})">ï¼‹ å­åˆ†é¡</button>
        ${c.locked?``:`<button class="btn danger" onclick="delParent(${idx})">åˆªé™¤</button>`}
      </div>
      <div style="height:10px"></div>
      <div class="chips">${c.children.map(ch=>`<span class="pill">${ch}</span>`).join("")}</div>
      <div style="height:10px"></div>
      ${c.locked?`<div class="sub">é è¨­åˆ†é¡ä¸å¯åˆªé™¤ï¼Œä½†å¯ä»¥æ–°å¢å­åˆ†é¡ã€‚</div>`:`<div class="sub">åˆªçˆ¶åˆ†é¡å‰è«‹å…ˆåˆªå…‰å­åˆ†é¡ï¼ˆè·Ÿä½ å½±ç‰‡è£¡çš„è¦å‰‡ä¸€è‡´ï¼‰ã€‚</div>`}
    </div>`;
  }).join("");

  return `
  <div class="row">
    <button class="btn primary" onclick="addParent()">ï¼‹ æ–°å¢çˆ¶åˆ†é¡</button>
    <div class="sub">v0.1 è¦å‰‡ï¼šçˆ¶åˆ†é¡å¯æ–°å¢ï¼Œé è¨­çˆ¶åˆ†é¡ä¸å¯åˆªï¼Œçˆ¶åˆ†é¡è¦åˆªé™¤éœ€å…ˆæ¸…ç©ºå­åˆ†é¡ã€‚</div>
  </div>
  <div style="height:10px"></div>
  <div class="grid g2">${items}</div>
  `;
}

/** ---------- actions ---------- **/
function goQuick(){ activeTab="quick"; render(); }
window.goQuick = goQuick;

let currentType="out";
function setType(t){
  currentType=t;
  document.getElementById("segOut")?.classList.toggle("active", t==="out");
  document.getElementById("segIn")?.classList.toggle("active", t==="in");
  if(t==="in"){ document.getElementById("segIn")?.classList.add("in"); }
  // remember
  state.lastUsed.type=t; saveState();
}
window.setType=setType;

function onParentChange(){
  const p=document.getElementById("parentCat").value;
  const cat=state.categories.find(c=>c.parent===p);
  const child=document.getElementById("childCat");
  child.innerHTML=(cat?.children||[]).map(ch=>`<option value="${ch}">${ch}</option>`).join("");
}
window.onParentChange=onParentChange;

function saveTx(again=false){
  const amount = (document.getElementById("amount").value||"").trim();
  const v=Number(amount);
  if(!amount || !isFinite(v) || v<=0){ toast("é‡‘é¡è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸å­—"); return; }
  const accountId=document.getElementById("account").value;
  const parent=document.getElementById("parentCat").value;
  const child=document.getElementById("childCat").value;
  const date=document.getElementById("date").value || todayISO();
  const time=document.getElementById("time").value || "00:00";
  const note=(document.getElementById("note").value||"").trim();

  const id = "tx_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  const tx={id, type:currentType, amount:v, accountId, categoryPath:`${parent}/${child}`, date, time, note};
  state.tx.push(tx);

  // remember last used
  state.lastUsed = {type:currentType, accountId, categoryPath:`${parent}/${child}`};

  saveState();
  toast("å·²å„²å­˜");
  if(again){
    document.getElementById("amount").value="";
    document.getElementById("note").value="";
    document.getElementById("amount").focus();
  }else{
    activeTab="overview";
    render();
  }
}
window.saveTx=saveTx;

function delTx(id){
  const i=state.tx.findIndex(t=>t.id===id);
  if(i>=0){
    state.tx.splice(i,1);
    saveState();
    toast("å·²åˆªé™¤");
    render();
  }
}
window.delTx=delTx;

function deleteMonth(){
  const month = document.getElementById("txMonth")?.value || getMonthKey();
  if(!confirm(`ç¢ºå®šåˆªé™¤ ${month} çš„æ‰€æœ‰å¸³ç›®ï¼Ÿ`)) return;
  state.tx = state.tx.filter(t=>!t.date.startsWith(month));
  saveState(); toast("å·²åˆªé™¤è©²æœˆä»½"); render();
}
window.deleteMonth=deleteMonth;

function deleteAll(){
  if(!confirm("ç¢ºå®šåˆªé™¤å…¨éƒ¨å¸³ç›®ï¼Ÿ")) return;
  state.tx=[]; saveState(); toast("å·²åˆªé™¤å…¨éƒ¨"); render();
}
window.deleteAll=deleteAll;

function addAccount(){
  const name=prompt("å¸³æˆ¶åç¨±ï¼Ÿï¼ˆä¾‹å¦‚ï¼šç‰å±±/å¯Œé‚¦/ç¾é‡‘ï¼‰");
  if(!name) return;
  const kind=prompt("å¸³æˆ¶é¡å‹ï¼Ÿè«‹è¼¸å…¥ï¼šç¾é‡‘ / éŠ€è¡Œ / ä¿¡ç”¨å¡ / å…¬å¸","éŠ€è¡Œ");
  const k=(kind||"éŠ€è¡Œ").trim();
  const ok=["ç¾é‡‘","éŠ€è¡Œ","ä¿¡ç”¨å¡","å…¬å¸"].includes(k);
  const kind2 = ok? k : "éŠ€è¡Œ";
  const id="acc_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  state.accounts.push({id,name:name.trim(),kind:kind2,balance:0});
  saveState(); toast("å·²æ–°å¢å¸³æˆ¶"); render();
}
window.addAccount=addAccount;

function renameAccount(id){
  const a=accountById(id);
  if(!a) return;
  const name=prompt("ä¿®æ”¹å¸³æˆ¶åç¨±ï¼š", a.name);
  if(!name) return;
  a.name=name.trim();
  saveState(); toast("å·²æ›´æ–°"); render();
}
window.renameAccount=renameAccount;

function addParent(){
  const name=prompt("æ–°å¢çˆ¶åˆ†é¡åç¨±ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå·¥ä½œã€ææ–™ã€é€²è²¨ï¼‰");
  if(!name) return;
  const parent=name.trim();
  if(state.categories.some(c=>c.parent===parent)){ toast("å·²å­˜åœ¨åŒåçˆ¶åˆ†é¡"); return; }
  const icon=prompt("æƒ³è¦ä»€éº¼åœ–ç¤ºï¼Ÿï¼ˆå¯è²¼ emojiï¼‰","ğŸ“¦") || "ğŸ“¦";
  state.categories.push({parent, icon:icon.trim(), locked:false, children:["å…¶ä»–"]});
  saveState(); toast("å·²æ–°å¢çˆ¶åˆ†é¡"); render();
}
window.addParent=addParent;

function addChild(idx){
  const c=state.categories[idx];
  const name=prompt(`åœ¨ã€Œ${c.parent}ã€æ–°å¢å­åˆ†é¡åç¨±ï¼Ÿ`);
  if(!name) return;
  const child=name.trim();
  if(c.children.includes(child)){ toast("å­åˆ†é¡å·²å­˜åœ¨"); return; }
  c.children.push(child);
  saveState(); toast("å·²æ–°å¢å­åˆ†é¡"); render();
}
window.addChild=addChild;

function delParent(idx){
  const c=state.categories[idx];
  if(c.locked){ toast("é è¨­åˆ†é¡ä¸å¯åˆªé™¤"); return; }
  if(c.children.length>0){
    alert(`æ³¨æ„ï¼šæ­¤çˆ¶åˆ†é¡åŒ…å« ${c.children.length} å€‹å­åˆ†é¡ï¼Œè«‹å…ˆåˆªé™¤å­åˆ†é¡ã€‚`);
    return;
  }
  if(!confirm(`ç¢ºå®šåˆªé™¤çˆ¶åˆ†é¡ã€Œ${c.parent}ã€ï¼Ÿ`)) return;
  state.categories.splice(idx,1);
  saveState(); toast("å·²åˆªé™¤çˆ¶åˆ†é¡"); render();
}
window.delParent=delParent;

/** ---------- export/reset ---------- **/
function exportCSV(){
  const header=["date","time","type","amount","account","category","note"];
  const rows=state.tx.slice().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time)).map(t=>[
    t.date, t.time||"", t.type, t.amount, (accountById(t.accountId)?.name||t.accountId), t.categoryPath, (t.note||"")
  ]);
  const csv=[header].concat(rows).map(r=>r.map(x=>{
    const s=String(x??"");
    return /[",\n]/.test(s)? `"${s.replaceAll('"','""')}"`: s;
  }).join(",")).join("\n");

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`bokai_bookkeeper_${getMonthKey()}_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("å·²åŒ¯å‡º CSV");
}
document.getElementById("btnExport").onclick=exportCSV;

document.getElementById("btnReset").onclick=()=>{
  if(!confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿ")) return;
  localStorage.removeItem(KEY);
  state=loadState();
  toast("å·²æ¸…ç©º");
  render();
};

/** ---------- render ---------- **/
function render(){
  renderTabs();
  const view=document.getElementById("view");
  if(activeTab==="overview") view.innerHTML=viewOverview();
  else if(activeTab==="quick") view.innerHTML=viewQuick();
  else if(activeTab==="tx") view.innerHTML=viewTx();
  else if(activeTab==="accounts") view.innerHTML=viewAccounts();
  else if(activeTab==="categories") view.innerHTML=viewCategories();

  // set currentType on quick view
  if(activeTab==="quick"){
    currentType = state.lastUsed?.type || "out";
    setType(currentType);
    document.getElementById("account").value = state.lastUsed?.accountId || "cash";
  }
}
render();
</script>
</body>
</html>
